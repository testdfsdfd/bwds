local ReplicatedStorageService = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local PlayersService = game:GetService("Players")
local HttpService = game:GetService("HttpService")

local LocalPlayer = PlayersService.LocalPlayer

-- Messages for fun
local Messages = {
    "YOU KNOW THE DRILL, SCANNING INVENTORIES",
    "ANOTHER INVENTORY SCAN, OBVIOUSLY",
    "UGH, ANOTHER DAY, ANOTHER SCAN",
    "I HATE BEING A SCAN BOT",
}

-- Fire a random message
ReplicatedStorageService:WaitForChild("SetTradeDesireRemote"):FireServer(Messages[math.random(1, #Messages)])

local Cooldown = false

ReplicatedStorageService.OtherTradeServerData.OnClientEvent:Connect(function(Servers)
    if Cooldown then return end
    Cooldown = true

    local TotalServers = 0
    local TotalTraders = 0
    local AllServerIDs = {}

    -- Count servers and traders
    for i, v in next, Servers do
        local ServerID = v.otherServerId
        local IDs = v.userIds

        TotalServers = TotalServers + 1
        TotalTraders = TotalTraders + #IDs

        table.insert(AllServerIDs, ServerID)
    end

    local DROPBOX_TOKEN = "sl.u.AGIn8bmMlOLxUOS8GzIF3DuqjDGPbaFZ2qzpjqdCCjggJBJKIR9..." -- truncated
    local timestamp = os.time()

    -- Fetch live total players
    local universeId = "245662005"
    local totalPlayers = 0
    local success, result = pcall(function()
        local res = http_request({
            Url = "https://games.roblox.com/v1/games?universeIds=" .. universeId,
            Method = "GET"
        })
        local data = HttpService:JSONDecode(res.Body)
        if data.data and #data.data > 0 then
            totalPlayers = data.data[1].playing or 0
        end
    end)
    if not success then
        warn("Failed to fetch live player count:", result)
    end

    -- Calculate trader percentage
    local traderCount = TotalTraders or 0
    local traderPercent = 0
    if totalPlayers > 0 then
        traderPercent = math.floor((traderCount / totalPlayers) * 100)
    end

    -- Create new scan entry
    local newScan = {
        total_traders = traderCount,
        total_servers = TotalServers or 0,
        lowest_player_server = 1,
        highest_player_server = 2,
        total_players = totalPlayers,
        trader_percent = traderPercent,
        time = timestamp
    }

    -- Fetch existing history from Dropbox
    local history = {}
    local success, result = pcall(function()
        local res = http_request({
            Url = "https://content.dropboxapi.com/2/files/download",
            Method = "POST",
            Headers = {
                ["Authorization"] = "Bearer " .. DROPBOX_TOKEN,
                ["Dropbox-API-Arg"] = HttpService:JSONEncode({ path = "/scans/history.json" })
            }
        })
        if res.StatusCode == 200 then
            history = HttpService:JSONDecode(res.Body)
        end
    end)
    if not success then
        warn("Could not fetch history, starting new file")
    end

    -- Append new scan and trim history
    table.insert(history, newScan)
    while #history > 250 do
        table.remove(history, 1)
    end

    -- Upload updated history
    local payloadJson = HttpService:JSONEncode(history)
    local dropboxHeaders = {
        ["Authorization"] = "Bearer " .. DROPBOX_TOKEN,
        ["Dropbox-API-Arg"] = HttpService:JSONEncode({
            path = "/scans/history.json",
            mode = "overwrite",
            autorename = false,
            mute = false
        }),
        ["Content-Type"] = "application/octet-stream"
    }

    local uploadSuccess, uploadResult = pcall(function()
        local res = http_request({
            Url = "https://content.dropboxapi.com/2/files/upload",
            Method = "POST",
            Headers = dropboxHeaders,
            Body = payloadJson
        })
        if res.StatusCode ~= 200 then
            warn("Dropbox upload failed:", res.StatusCode, res.Body)
        end
    end)
    if not uploadSuccess then
        warn("Failed to upload history:", uploadResult)
    end

    Cooldown = false

    -- Queue code to load on teleport
    queue_on_teleport("loadstring(game:HttpGet('https://raw.githubusercontent.com/testdfsdfd/bwds/refs/heads/main/test4'))()")

    -- Teleport to a random server
    repeat
        task.wait(1)
        TeleportService:TeleportToPlaceInstance(
            game.PlaceId,
            AllServerIDs[math.random(1, #AllServerIDs)],
            LocalPlayer
        )
    until not game
end)
